files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_check_env.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      echo "Verifying environment variables..."
      
      # Check if Redis environment variables are set
      if [ -z "$REDIS_ENDPOINT" ]; then
        echo "REDIS_ENDPOINT is not set, setting manually..."
        export REDIS_ENDPOINT="spacegame-redis-uswest2.ikrael.0001.usw2.cache.amazonaws.com"
        echo "export REDIS_ENDPOINT=$REDIS_ENDPOINT" >> /etc/environment
      else
        echo "REDIS_ENDPOINT is set to $REDIS_ENDPOINT"
      fi
      
      if [ -z "$REDIS_PORT" ]; then
        echo "REDIS_PORT is not set, setting manually..."
        export REDIS_PORT="6379"
        echo "export REDIS_PORT=$REDIS_PORT" >> /etc/environment
      else
        echo "REDIS_PORT is set to $REDIS_PORT"
      fi
      
      # Ensure the app has a .env file
      mkdir -p /var/app/current
      cat << EOF > /var/app/current/.env
      REDIS_ENDPOINT=$REDIS_ENDPOINT
      REDIS_PORT=$REDIS_PORT
      NODE_ENV=production
      PORT=8081
      EOF
      
      # Set proper permissions
      chown -R webapp:webapp /var/app/current/.env
      
      # Print environment status
      echo "Current environment variables:"
      grep -E "REDIS_|NODE_ENV|PORT" /etc/environment
      
      # Test Redis connection
      echo "Testing Redis connection..."
      nc -z -v -w5 $REDIS_ENDPOINT $REDIS_PORT 2>&1
      
      exit 0 